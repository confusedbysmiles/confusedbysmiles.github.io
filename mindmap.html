<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Decolonial Thought &amp; Embodied Knowledge — Merged Mind Map</title>
<style>
    :root{
      --bg1:#667eea;
      --bg2:#764ba2;
      --glass: rgba(0,0,0,.65);
      --glass-light: rgba(255,255,255,.2);
      --gold:#ffd700;
      --white:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: #000000;
      overflow:hidden;
      color:#fff;
    }
    /* Header */
    header{
      position:fixed;
      top:0;left:0;right:0;
      z-index:1100;
      padding:14px 20px 10px 20px;
      backdrop-filter:saturate(140%) blur(6px);
      background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.25));
      border-bottom:1px solid rgba(255,255,255,.15);
      display:flex;align-items:center;justify-content:space-between;
    }
    header h1{
      margin:0;
      font-weight:800;
      font-size: clamp(16px, 3vw, 22px);
      letter-spacing:.3px;
    }
    header .sub{
      opacity:.85;font-weight:500;font-size:.9em
    }

    /* Canvas sits below header/controls via a top offset */
    #stage{ position:fixed; inset:0; padding-top:120px; }
    #canvas{ width:100%; height:100%; display:block; }

    /* Controls (left) */
    .controls{
      position:fixed; top:64px; left:16px; z-index:1200;
      background:var(--glass); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.2);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      max-width:320px;
    }
    .controls h3{margin:0 0 8px 0; font-size:14px; font-weight:700; letter-spacing:.35px; color:#fff}
    .controls .row{display:flex; flex-wrap:wrap; gap:8px}
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.25); background:var(--glass-light);
      color:#fff; border-radius:999px; padding:8px 12px; font-weight:600; cursor:pointer;
      transition:transform .12s ease, background .2s ease;
      font-size:12px;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.28)}
    .hint{opacity:.8; font-size:12px; margin-top:6px}

    /* Legend (right) */
    .legend{
      position:fixed; top:64px; right:16px; z-index:1200;
      background:var(--glass); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.2);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      min-width:210px;
      font-size:13px;
    }
    .legend h4{margin:0 0 8px 0; color:var(--gold); font-weight:800; letter-spacing:.35px}
    .legend-item{display:flex; align-items:center; gap:10px; margin:6px 0}
    .dot{width:14px; height:14px; border-radius:50%}
    .badge-legend{
      position:relative; width:20px; height:20px; border-radius:50%; background:#fff; color:#000;
      display:grid; place-items:center; font-size:12px; font-weight:800; border:1px solid rgba(0,0,0,.1);
    }

    /* Info panel (bottom) */
    .info{
      position:fixed; left:16px; right:16px; bottom:16px; z-index:1200;
      background:var(--glass); border:1px solid rgba(255,255,255,.2);
      border-radius:12px; padding:14px 16px; max-height:220px; overflow:auto;
      opacity:0; transform:translateY(12px); transition:all .18s ease;
    }
    .info.active{opacity:1; transform:none}
    .info h3{margin:0 0 6px 0; color:var(--gold); font-size:16px}
    .quote{border-left:3px solid var(--gold); padding-left:12px; font-style:italic; margin:8px 0}

    .sr-only{position:relative;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
<header>
<div>
<h1>Decolonial Thought &amp; Embodied Knowledge</h1>
<div class="sub">An interactive map of ideas, practices, and lived experience</div>
</div>
<div aria-hidden="true" class="sr-only">Use arrow keys to pan; scroll to zoom; click nodes to expand/collapse.</div>
</header>
<div id="stage">
<canvas aria-label="Mind map canvas" id="canvas" role="img"></canvas>
</div>
<aside aria-label="Map controls" class="controls">
<h3>Navigate the Map</h3>
<div class="row" style="margin-bottom:8px">
<button class="btn" id="resetViewBtn" title="Reset pan/zoom">Reset View</button>
<button class="btn" id="expandAllBtn" title="Expand all sub-concepts">Expand All</button>
<button class="btn" id="collapseAllBtn" title="Collapse all sub-concepts">Collapse All</button>
</div>
<div class="row">
<button class="btn" id="toggleAnimBtn">Toggle Animation</button>
<button class="btn" id="toggleConnBtn">Toggle Connections</button>
</div>
<div class="hint">Click nodes to explore • Drag to pan • Scroll / pinch to zoom</div>
</aside>
<aside aria-label="Legend" class="legend">
<h4>Themes</h4>
<div class="legend-item"><span class="dot" style="background:#ff6b6b"></span>Colonial / Western Thought</div>
<div class="legend-item"><span class="dot" style="background:#4ecdc4"></span>Indigenous &amp; Alternative Knowledge</div>
<div class="legend-item"><span class="dot" style="background:#ffe66d"></span>Personal Experience</div>
<div class="legend-item"><span class="dot" style="background:#95e77e"></span>Educational Practice</div>
<div class="legend-item"><span class="dot" style="background:#b4a7d6"></span>Theory &amp; Critique</div>
<div class="legend-item" title="Number of hidden sub-concepts">
<span aria-hidden="true" class="badge-legend">#</span> White dot = hidden sub-concepts
    </div>
</aside>
<section aria-live="polite" class="info" id="infoPanel">
<h3 id="infoTitle">Click a node to explore</h3>
<div id="infoContent"></div>
</section>
<script>
    // ===== Canvas basics =====
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    function fit() {
      const rect = document.getElementById('stage').getBoundingClientRect();
      canvas.width = Math.floor(rect.width);
      canvas.height = Math.floor(rect.height);
    }
    window.addEventListener('resize', fit);
    fit();

    // ===== World transform (pan/zoom) =====
    let scale = 0.55;          // start with overview zoom level
    let offsetX = canvas.width * 0.5;
    let offsetY = canvas.height * 0.5;
    let isDragging = false;
    let dragStart = {x:0,y:0};
    let lastOffset = {x:offsetX,y:offsetY};

    // ===== Toggles =====
    let animationEnabled = true;
    let connectionsEnabled = true;
    let time = 0;

    // ===== Node model =====
    const COLORS = {
      colonial: '#ff6b6b',
      indigenous: '#4ecdc4',
      personal: '#ffe66d',
      practice: '#95e77e',
      theory: '#b4a7d6',
      center: '#ffd700'
    };

    /** Node: id, label, x, y, size, colorKey, content, quote, children[], parent, expanded */
    const NODES = {};
    const CONNECTIONS = []; // [id1,id2]

    function addNode(n){
      NODES[n.id] = Object.assign({children:[], parent:null, expanded:false}, n);
    }
    function connect(a,b){ CONNECTIONS.push([a,b]); }
    function addChild(parentId, child){
      child.parent = parentId;
      addNode(child);
      NODES[parentId].children.push(child.id);
      connect(parentId, child.id);
    }

    // ---- Seed nodes (center + major clusters) ----
    addNode({ id:'center', label:'Decolonial Thought\\n& Embodied Knowledge', x:0, y:0, size:44, colorKey:'center',
      content:'The intersection of personal healing, indigenous wisdom, and resistance to colonial frameworks of knowledge.',
      quote:'\"Coming home begins with the self.\"' });

    // Colonial / Western
    addNode({ id:'colonial-transcendence', label:'Colonial\\nTranscendence', x:-550, y:-220, size:32, colorKey:'colonial',
      content:'Push to transcend the so-called baseness of the body into abstract objectivity.',
      quote:'\"In trying to become objective, western culture made objects of things and people.\" — Anzaldúa' });
    addNode({ id:'objectification', label:'Objectification\\n& Violence', x:-700, y:70, size:27, colorKey:'colonial',
      content:'Distancing from embodied experience becomes the root of violence through objectification.'});
    addNode({ id:'planned-obsolescence', label:'Planned\\nObsolescence', x:-380, y:-420, size:24, colorKey:'colonial',
      content:'Rejecting lasting, mended relationships with the material world — the anti-rasquache logic.'});

    // Indigenous / Alternative
    addNode({ id:'rasquachismo', label:'Rasquachismo', x:520, y:-220, size:34, colorKey:'indigenous',
      content:'Bawdy, spunky consciousness of survival through remaking, mending, and subversion.',
      quote:'\"Down but not out.\"' });
    addNode({ id:'blackfoot', label:'Blackfoot\\nWisdom', x:740, y:-30, size:28, colorKey:'indigenous',
      content:'We are part of every ecosystem; language is everything; no land without culture.'});
    addNode({ id:'decolonization', label:'Decolonization\\nProcess', x:620, y:170, size:26, colorKey:'indigenous',
      content:'Entails remembrance — Kaaahsinnooniksi, the teachings of the ancestors and ancients.'});

    // Personal
    addNode({ id:'dissociation', label:'Dissociation\\n& Survival', x:-40, y:340, size:26, colorKey:'personal',
      content:'Leaving the body as survival mirrors colonial schooling’s push away from embodied knowledge.'});
    addNode({ id:'healing', label:'Embodied\\nHealing', x:240, y:360, size:28, colorKey:'personal',
      content:'Protecting space for presence, boredom, and reflection; returning to the body.', quote:'\"I came to theory because I was hurting.\" — bell hooks' });

    // Practice (Education)
    addNode({ id:'achievement-vs-opportunity', label:'Achievement Gap\\nvs Opportunity Gap', x:230, y:-440, size:28, colorKey:'practice',
      content:'Framing matters: opportunity gap recognizes systemic failure rather than blaming students.'});
    addNode({ id:'silver-bullets', label:'Silver Bullet\\nPolicies', x:10, y:-320, size:28, colorKey:'practice',
      content:'NCLB, Race to the Top — rhetoric of equity, same restrictive systems.'});
    addNode({ id:'testing', label:'Testing &\\nStratification', x:-180, y:-140, size:24, colorKey:'practice',
      content:'High-stakes testing confirms stratification and measures assimilation, not learning.'});
    addNode({ id:'csp', label:'Culturally Sustaining\\nPedagogy', x:560, y:260, size:30, colorKey:'practice',
      content:'Asset-based pedagogy valuing students’ languages, cultures, funds of knowledge.'});

    // Theory
    addNode({ id:'hooks', label:'bell hooks:\\nTheory as Healing', x:-320, y:440, size:22, colorKey:'theory',
      content:'Theory as a location for healing and comprehension.'});
    addNode({ id:'anzaldua', label:'Anzaldúa:\\nArt & Identity', x:780, y:420, size:22, colorKey:'theory',
      content:'Art as identity; creativity is political; dichotomy breeds violence.'});

    // Connections
    [
      ['center','colonial-transcendence'],['center','rasquachismo'],['center','dissociation'],
      ['center','csp'],['colonial-transcendence','objectification'],['colonial-transcendence','planned-obsolescence'],
      ['objectification','dissociation'],['rasquachismo','blackfoot'],['rasquachismo','decolonization'],
      ['rasquachismo','csp'],['blackfoot','decolonization'],['dissociation','healing'],
      ['healing','csp'],['achievement-vs-opportunity','silver-bullets'],['silver-bullets','testing'],
      ['achievement-vs-opportunity','csp'],['hooks','healing'],['anzaldua','objectification'],['anzaldua','rasquachismo']
    ].forEach(([a,b])=>connect(a,b));

    // ---- Sub-nodes (children) ----
    const extraChildren = [
      // Educational critique & policy
      ['silver-bullets',{ id:'ordinary-genocide', label:'Ordinary\\nGenocide', x:-40, y:-430, size:19, colorKey:'practice',
        content:'Policies and practices creating generations of people who function as “ghosts.”' }],
      ['silver-bullets',{ id:'nclb-resegregated', label:'NCLB\\nResegregated Schools', x:-120, y:-360, size:19, colorKey:'practice',
        content:'Policy rhetoric of equity, outcomes of resegregation and testing compliance.' }],
      ['achievement-vs-opportunity',{ id:'revisionist-history', label:'Revisionist History\\n& Failure as Moral Flaw', x:360, y:-480, size:19, colorKey:'practice',
        content:'Deficit narratives frame systemic harm as individual failure.' }],
      ['csp',{ id:'funds-of-knowledge', label:'Funds of\\nKnowledge', x:700, y:230, size:18, colorKey:'practice',
        content:'Center learners’ experiences and community knowledge as assets.' }],
      ['csp',{ id:'afrocentric-praxis', label:'Afrocentric\\nPraxis', x:650, y:340, size:18, colorKey:'practice',
        content:'Loved approach often ignored due to its name; centers African epistemologies.' }],
      // Rasquache extensions
      ['rasquachismo',{ id:'problem-solving-ras', label:'Problem-Solving as\\nRasquachismo', x:740, y:-300, size:18, colorKey:'indigenous',
        content:'“F— shout it from the rooftops!” Improvisation and repair as brilliance.' }],
      ['rasquachismo',{ id:'drag-aesthetic', label:'Drag Aesthetic', x:620, y:-340, size:18, colorKey:'indigenous',
        content:'Pattern-on-pattern playfulness; exuberant recombination and mending.' }],
      // Personal & practice
      ['healing',{ id:'reinterpreting-past', label:'Reinterpreting Past\\nExperiences', x:180, y:470, size:18, colorKey:'personal',
        content:'Fresh meanings emerge through embodied presence and reflection.' }],
      ['dissociation',{ id:'busyness-dissociation', label:'Busyness as\\nDissociation', x:-110, y:470, size:18, colorKey:'personal',
        content:'Productivity as avoidance; radical rest as counter-practice.' }],
      ['csp',{ id:'one-brave-student', label:'One Brave Student', x:500, y:360, size:16, colorKey:'practice',
        content:'Student voice naming math as a snake—vivid metaphor opening dialogue.' }],
      ['csp',{ id:'traveling-teacher', label:'Traveling Teacher\\nwith Cart', x:480, y:460, size:16, colorKey:'practice',
        content:'Resource constraints met with ingenuity in practice.' }],
      // More theory/critique
      ['colonial-transcendence',{ id:'apolitical-is-political', label:'“Apolitical” is\\nPolitical', x:-540, y:-330, size:18, colorKey:'theory',
        content:'Neutrality aligns with dominance; distancing enables harm.' }],
      ['objectification',{ id:'statistics-are-people', label:'Statistics are\\nPeople', x:-850, y:150, size:18, colorKey:'theory',
        content:'Fight dehumanization by insisting on lived realities behind numbers.' }],
      // Blackfoot & land
      ['blackfoot',{ id:'language-is-everything', label:'Language is\\nEverything', x:900, y:0, size:18, colorKey:'indigenous',
        content:'Embodiment through language, land, and lifeways.' }],
      ['blackfoot',{ id:'no-land-no-culture', label:'No Land ⇄ No Culture', x:860, y:80, size:18, colorKey:'indigenous',
        content:'Mutual constitution of place and culture.' }],
      // More schooling critique
      ['testing',{ id:'assimilation-gap', label:'Achievement Gap ⇢\\nAssimilation Gap', x:-320, y:-100, size:18, colorKey:'practice',
        content:'Tests gauge conformity to norms, not authentic learning.' }],
      ['testing',{ id:'stratification-confirmed', label:'Stratification\\nConfirmed', x:-260, y:-40, size:18, colorKey:'practice',
        content:'High-stakes decisions preserve hierarchies.' }],
      // Misc from notes
      ['rasquachismo',{ id:'minutia-everyday-life', label:'Minutia of\\nEveryday Life', x:520, y:-110, size:18, colorKey:'indigenous',
        content:'Attention to small, sustaining practices; Pasquache residency.' }],
    ];
    extraChildren.forEach(([p,c])=>addChild(p,c));

    // Expand defaults
    NODES['center'].expanded = true;

    // Helper: count hidden children
    function hiddenCount(parent){
      let cnt = 0;
      for(const id of parent.children){
        const child = NODES[id];
        if(!parent.expanded) cnt++;
      }
      return cnt;
    }

    // ===== Interaction: pan/zoom =====
    canvas.addEventListener('mousedown', (e)=>{
      isDragging = true;
      dragStart.x = e.clientX; dragStart.y = e.clientY;
      lastOffset.x = offsetX; lastOffset.y = offsetY;
    });
    window.addEventListener('mouseup', ()=>{ isDragging = false; });
    window.addEventListener('mousemove', (e)=>{
      if(isDragging){
        offsetX = lastOffset.x + (e.clientX - dragStart.x);
        offsetY = lastOffset.y + (e.clientY - dragStart.y);
      }
    });
    canvas.addEventListener('wheel', (e)=>{
      e.preventDefault();
      const zoom = Math.exp(-e.deltaY * 0.0012);
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const wx = (mx - offsetX)/scale;
      const wy = (my - offsetY)/scale;
      scale *= zoom;
      offsetX = mx - wx * scale;
      offsetY = my - wy * scale;
    }, { passive:false });

    // Keyboard pan
    window.addEventListener('keydown',(e)=>{
      const step = 30;
      if(e.key==='ArrowLeft') offsetX+=step;
      if(e.key==='ArrowRight') offsetX-=step;
      if(e.key==='ArrowUp') offsetY+=step;
      if(e.key==='ArrowDown') offsetY-=step;
      if(e.key==='0' && (e.ctrlKey||e.metaKey)) resetView();
    });

    // ===== Hit testing (click to expand/collapse, or select) =====
    let hoveredId = null;
    let selectedId = null;

    function screenFromWorld(x,y){ return { x: x*scale + offsetX, y: y*scale + offsetY }; }
    function worldFromScreen(x,y){ return { x: (x - offsetX)/scale, y: (y - offsetY)/scale }; }

    function getNodeAt(mx,my){
      const w = worldFromScreen(mx,my);
      const ids = Object.keys(NODES);
      for(let i=ids.length-1;i>=0;i--){
        const n = NODES[ids[i]];
        if(n.parent && !NODES[n.parent].expanded) continue;
        const r = n.size * (hoveredId===n.id?1.2:1);
        const dx = w.x - n.x, dy = w.y - n.y;
        if(dx*dx + dy*dy <= r*r) return n;
      }
      return null;
    }

    canvas.addEventListener('mousemove', (e)=>{
      const rect = canvas.getBoundingClientRect();
      const n = getNodeAt(e.clientX-rect.left, e.clientY-rect.top);
      hoveredId = n ? n.id : null;
      canvas.style.cursor = n ? 'pointer' : (isDragging ? 'grabbing' : 'default');
    });

    canvas.addEventListener('click', (e)=>{
      const rect = canvas.getBoundingClientRect();
      const n = getNodeAt(e.clientX-rect.left, e.clientY-rect.top);
      if(!n) { selectedId = null; setInfo(null); return; }
      selectedId = n.id;
      if(n.children && n.children.length){
        n.expanded = !n.expanded;
      }
      setInfo(n);
    });

    // ===== Info panel =====
    const infoPanel = document.getElementById('infoPanel');
    const infoTitle = document.getElementById('infoTitle');
    const infoContent = document.getElementById('infoContent');

    function setInfo(n){
      if(!n){ infoPanel.classList.remove('active'); return; }
      infoPanel.classList.add('active');
      infoTitle.textContent = n.label.replaceAll('\\n',' ');
      infoContent.innerHTML = `
        <div style="line-height:1.6">${n.content ? n.content : ''}</div>
        ${n.quote ? `<div class="quote">${n.quote}</div>` : ''}
        ${n.children && n.children.length ? `<div style="opacity:.85;margin-top:6px">Sub-concepts: ${n.children.length} • Click node to ${n.expanded?'collapse':'expand'}.</div>`:''}
      `;
    }

    // ===== Layout helpers for expanded children (simple radial) =====
    function layoutChildren(n){
      const children = n.children.map(id => NODES[id]);
      const R = n.size + 52;
      const step = Math.PI * 2 / Math.max(1, children.length);
      children.forEach((c, i)=>{
        if(!n.expanded) return;
        const angle = i*step - Math.PI/2;
        const targetX = n.x + Math.cos(angle) * (R + (i % 3) * 20);
        const targetY = n.y + Math.sin(angle) * (R + (i % 3) * 20);
        c.x += (targetX - c.x) * 0.12;
        c.y += (targetY - c.y) * 0.12;
      });
    }

    // ===== Drawing =====
    function drawConnection(a,b){
      if(!connectionsEnabled) return;
      const n1 = NODES[a], n2 = NODES[b];
      if(n1.parent && !NODES[n1.parent].expanded) return;
      if(n2.parent && !NODES[n2.parent].expanded) return;
      const p1 = screenFromWorld(n1.x, n1.y + float(n1));
      const p2 = screenFromWorld(n2.x, n2.y + float(n2));
      ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
      ctx.lineWidth = 1.5; ctx.strokeStyle = 'rgba(255,255,255,.35)'; ctx.stroke();
    }
    function float(n){ return animationEnabled ? Math.sin((time*0.001) + n.id.length)*3 : 0; }

    // === Text-fitting helpers (from template idea) ===
    function drawMultilineFittedText(text, centerX, centerY, radius){
      const lines = text.split('\\n');
      // Binary search font size that fits both width and total height constraints
      let lo = 8, hi = Math.max(16, Math.floor(radius*0.9)), best = lo;
      while(lo <= hi){
        const mid = Math.floor((lo+hi)/2);
        ctx.font = `${mid}px Inter, Arial, sans-serif`;
        let maxWidth = 0;
        for(const line of lines){
          const w = ctx.measureText(line).width;
          if(w > maxWidth) maxWidth = w;
        }
        const totalH = mid * lines.length * 1.2;
        if(maxWidth <= radius*1.8 && totalH <= radius*1.8){
          best = mid; lo = mid+1;
        } else {
          hi = mid-1;
        }
      }
      ctx.font = `${best}px Inter, Arial, sans-serif`;
      ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#fff';
      lines.forEach((line,i)=>{
        ctx.fillText(line, centerX, centerY + (i - (lines.length-1)/2)*best*1.2);
      });
    }

    function drawNode(n){
      if(n.parent && !NODES[n.parent].expanded) return;
      const p = screenFromWorld(n.x, n.y + float(n));
      const hovered = (hoveredId === n.id);
      const selected = (selectedId === n.id);

      // Glow
      if(hovered || selected){
        ctx.shadowBlur = 18;
        ctx.shadowColor = COLORS[n.colorKey] || '#fff';
      } else ctx.shadowBlur = 0;

      // Circle
      const r = n.size * (hovered?1.2:1);
      ctx.beginPath(); ctx.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx.fillStyle = COLORS[n.colorKey] || '#fff';
      ctx.fill();
      ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(255,255,255,.85)'; ctx.stroke();

      // Label using fitted text
      ctx.shadowBlur = 0;
      drawMultilineFittedText(n.label, p.x, p.y, r);

      // Hidden children badge
      if(n.children && n.children.length){
        const count = hiddenCount(n);
        if(count>0){
          const br = 12, bx = p.x + r + 4, by = p.y - r - 4;
          ctx.beginPath(); ctx.arc(bx, by, br, 0, Math.PI*2);
          ctx.fillStyle = '#fff'; ctx.fill();
          ctx.lineWidth = 1; ctx.strokeStyle = 'rgba(0,0,0,.25)'; ctx.stroke();
          ctx.fillStyle = '#000'; ctx.font = 'bold 12px Inter, Arial, sans-serif';
          ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText(String(count), bx, by+0.5);
        }
      }
    }

    function autoSizeNodes(){
      for(const id in NODES){
        const n = NODES[id];
        if(typeof n.size === "number" && n.size > 0){
          // keep existing size unless label doesn't fit
          const lines = n.label.split("\n");
          ctx.font = "14px Inter, Arial, sans-serif";
          let maxWidth = 0;
          for(const line of lines){
            maxWidth = Math.max(maxWidth, ctx.measureText(line).width);
          }
          const needed = Math.max(maxWidth, lines.length * 16 * 1.2);
          if(needed/2 + 8 > n.size){
            n.size = needed/2 + 8;
          }
        } else {
          // if no size defined, compute new size
          const lines = n.label.split("\n");
          ctx.font = "14px Inter, Arial, sans-serif";
          let maxWidth = 0;
          for(const line of lines){
            maxWidth = Math.max(maxWidth, ctx.measureText(line).width);
          }
          const needed = Math.max(maxWidth, lines.length * 16 * 1.2);
          n.size = needed/2 + 8;
        }
      }
    }
        const needed = Math.max(maxWidth, lines.length * 16 * 1.2);
        n.size = Math.max(n.size || 20, needed / 2 + 8); // grow radius so text fits
      }
    }
    }

    function tick(){
      time += 16;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      autoSizeNodes();

      // Layout expanded children
      for(const id in NODES){
        const n = NODES[id];
        if(n.children && n.children.length && n.expanded){
          layoutChildren(n);
        }
      }
      CONNECTIONS.forEach(([a,b])=>drawConnection(a,b));
      for(const id in NODES){ drawNode(NODES[id]); }

      if(animationEnabled) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // ===== Controls =====
    function resetView(){
      scale = 0.55;
      offsetX = canvas.width*0.5;
      offsetY = canvas.height*0.5;
    }
    function expandAll(){ Object.values(NODES).forEach(n=>{ if(n.children?.length) n.expanded = true; }); }
    function collapseAll(){
      Object.values(NODES).forEach(n=>{ if(n.children?.length) n.expanded = false; });
      NODES['center'].expanded = true;
    }
    function toggleAnim(){ animationEnabled = !animationEnabled; if(animationEnabled) requestAnimationFrame(tick); }
    function toggleConn(){ connectionsEnabled = !connectionsEnabled; }

    document.getElementById('resetViewBtn').addEventListener('click', resetView);
    document.getElementById('expandAllBtn').addEventListener('click', expandAll);
    document.getElementById('collapseAllBtn').addEventListener('click', collapseAll);
    document.getElementById('toggleAnimBtn').addEventListener('click', toggleAnim);
    document.getElementById('toggleConnBtn').addEventListener('click', toggleConn);

    offsetY += 10; // initial nudge
  </script>
</body>
</html>
